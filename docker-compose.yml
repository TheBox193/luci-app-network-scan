services:
  netdiscover-bootstrap:
    image: openwrt/sdk:ipq806x-chromium-24.10.5
    working_dir: /builder
    user: buildbot
    volumes:
      - ./feeds.conf:/builder/feeds.conf:ro
      - ./feeds:/builder/feeds
      - ./luci-app-netdiscover:/builder/package/luci-app-netdiscover
      - ./dl:/builder/dl
    command: >
      /bin/sh -lc '
        export TERM=xterm
        retry_count=0
        until ./scripts/feeds update packages luci; do
          retry_count=$$((retry_count + 1))
          if [ "$$retry_count" -ge 3 ]; then
            exit 1
          fi
          sleep 5
        done
        ./scripts/feeds install -p packages lua luasrcdiet
        ./scripts/feeds install -p luci luci-base luci-lib-jsonc luci-lib-nixio rpcd-mod-luci lucihttp ucode-mod-lua ucode-mod-html luci-lua-runtime
        make defconfig
      '

  netdiscover-build:
    image: openwrt/sdk:ipq806x-chromium-24.10.5
    working_dir: /builder
    user: buildbot
    volumes:
      - ./feeds.conf:/builder/feeds.conf:ro
      - ./feeds:/builder/feeds
      - ./luci-app-netdiscover:/builder/package/luci-app-netdiscover
      - ./bin:/builder/bin
      - ./dl:/builder/dl
    command: >
      /bin/sh -lc '
        export TERM=xterm
        make package/lua/compile -j1 V=sc
        make package/luci-app-netdiscover/clean package/luci-app-netdiscover/compile -j1 V=sc
      '

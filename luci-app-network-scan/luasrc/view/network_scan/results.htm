<%+header%>

<div class="cbi-section">
  <h2>Network Scan</h2>
  <div class="cbi-section-node" style="margin-bottom: 12px;">
    <button id="network-scan-scan" class="cbi-button cbi-button-action">Scan now</button>
    <span id="network-scan-status" style="margin-left: 12px;"></span>
  </div>
  <div class="cbi-section-node" style="margin-bottom: 12px;">
    <label style="margin-right: 16px;">
      <input type="checkbox" id="network-scan-arp-scan" checked />
      ARP scan (if installed)
    </label>
    <label style="margin-right: 16px;">
      <input type="checkbox" id="network-scan-icmp-sweep" />
      ICMP sweep (nmap -sn)
    </label>
    <label style="margin-right: 16px;">
      <input type="checkbox" id="network-scan-tcp-probe" />
      TCP probe (nmap open ports)
    </label>
    <label>
      Ports:
      <input type="text" id="network-scan-tcp-ports" value="22,80,443,23" style="width: 140px;" />
    </label>
  </div>
  <div class="cbi-section-node" style="margin-bottom: 12px;">
    <label style="margin-right: 12px;">
      Scope:
      <select id="network-scan-scope">
        <option value="auto">LAN subnets (auto)</option>
        <option value="custom">Custom</option>
      </select>
    </label>
    <label>
      Targets:
      <input type="text" id="network-scan-scope-targets" value="" placeholder="192.168.1.0/24" style="width: 260px;" />
    </label>
  </div>
  <div class="cbi-section-node" style="margin-bottom: 12px;">
    <label style="margin-right: 16px;">
      <input type="checkbox" id="network-scan-hide-ipv6-linklocal" checked />
      Hide IPv6 link-local
    </label>
    <label>
      <input type="checkbox" id="network-scan-hide-ipv4-linklocal" checked />
      Hide IPv4 link-local
    </label>
  </div>
  <div class="cbi-section-node" style="margin-bottom: 12px;">
    <div id="network-scan-tabbar">
      <button class="cbi-button" data-tab="summary">Summary</button>
      <button class="cbi-button" data-tab="scope">Scope</button>
      <button class="cbi-button" data-tab="arp">ARP & Neighbors</button>
      <button class="cbi-button" data-tab="dhcp">DHCP</button>
      <button class="cbi-button" data-tab="wifi">Wi-Fi</button>
      <button class="cbi-button" data-tab="nmap-ping">Nmap Ping</button>
      <button class="cbi-button" data-tab="nmap-ports">Nmap Ports</button>
      <button class="cbi-button" data-tab="host-hints">Host Hints</button>
      <button class="cbi-button" data-tab="interfaces">Interfaces</button>
    </div>
  </div>

  <div id="network-scan-tab-summary" class="network-scan-tab">
    <div id="network-scan-meta" style="margin-bottom: 12px; color: #555;"></div>

    <table class="table" id="network-scan-table">
      <thead>
        <tr class="tr table-titles">
          <th class="th">MAC</th>
          <th class="th">Vendor</th>
          <th class="th">IP Address(es)</th>
          <th class="th">DHCP</th>
          <th class="th">Hostname(s)</th>
          <th class="th">Connection</th>
          <th class="th">Interface</th>
          <th class="th">RSSI</th>
          <th class="th">Seen Via</th>
          <th class="th">Liveness</th>
          <th class="th">Last Seen</th>
          <th class="th">Flags</th>
          <th class="th">Actions</th>
        </tr>
      </thead>
      <tbody id="network-scan-body">
        <tr class="tr">
          <td class="td" colspan="13">No scan results yet.</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div id="network-scan-tab-scope" class="network-scan-tab" style="display: none;">
    <div class="cbi-section-node">
      <pre id="network-scan-evidence-scope">Loading…</pre>
    </div>
  </div>

  <div id="network-scan-tab-arp" class="network-scan-tab" style="display: none;">
    <div class="cbi-section-node">
      <pre id="network-scan-evidence-arp">Loading…</pre>
    </div>
  </div>

  <div id="network-scan-tab-dhcp" class="network-scan-tab" style="display: none;">
    <div class="cbi-section-node">
      <pre id="network-scan-evidence-dhcp">Loading…</pre>
    </div>
  </div>

  <div id="network-scan-tab-wifi" class="network-scan-tab" style="display: none;">
    <div class="cbi-section-node">
      <pre id="network-scan-evidence-wifi">Loading…</pre>
    </div>
  </div>

  <div id="network-scan-tab-nmap-ping" class="network-scan-tab" style="display: none;">
    <div class="cbi-section-node">
      <pre id="network-scan-evidence-nmap-ping">Loading…</pre>
    </div>
  </div>

  <div id="network-scan-tab-nmap-ports" class="network-scan-tab" style="display: none;">
    <div class="cbi-section-node">
      <pre id="network-scan-evidence-nmap-ports">Loading…</pre>
    </div>
  </div>

  <div id="network-scan-tab-host-hints" class="network-scan-tab" style="display: none;">
    <div class="cbi-section-node">
      <pre id="network-scan-evidence-host-hints">Loading…</pre>
    </div>
  </div>

  <div id="network-scan-tab-interfaces" class="network-scan-tab" style="display: none;">
    <div class="cbi-section-node">
      <pre id="network-scan-evidence-interfaces">Loading…</pre>
    </div>
  </div>
</div>

<script type="text/javascript">
(function() {
  var statusUrl = '<%=luci.dispatcher.build_url("admin", "network", "network-scan", "status")%>';
  var scanUrl = '<%=luci.dispatcher.build_url("admin", "network", "network-scan", "scan")%>';
  var resultsUrl = '<%=luci.dispatcher.build_url("admin", "network", "network-scan", "results")%>';
  var rawUrlBase = '<%=luci.dispatcher.build_url("admin", "network", "network-scan", "raw")%>';

  var scanButton = document.getElementById("network-scan-scan");
  var statusNode = document.getElementById("network-scan-status");
  var metaNode = document.getElementById("network-scan-meta");
  var tableBody = document.getElementById("network-scan-body");
  var arpScanToggle = document.getElementById("network-scan-arp-scan");
  var icmpSweepToggle = document.getElementById("network-scan-icmp-sweep");
  var tcpProbeToggle = document.getElementById("network-scan-tcp-probe");
  var tcpPortsInput = document.getElementById("network-scan-tcp-ports");
  var scopeSelect = document.getElementById("network-scan-scope");
  var scopeTargetsInput = document.getElementById("network-scan-scope-targets");
  var hideIpv6LinkLocalToggle = document.getElementById("network-scan-hide-ipv6-linklocal");
  var hideIpv4LinkLocalToggle = document.getElementById("network-scan-hide-ipv4-linklocal");
  var tabButtons = document.querySelectorAll("#network-scan-tabbar button[data-tab]");
  var tabSections = document.querySelectorAll(".network-scan-tab");

  var pollingTimer = null;
  var lastResults = null;
  var lastEvidenceTab = null;

  function requestJson(url, method, onDone) {
    var xhr = new XMLHttpRequest();
    xhr.open(method || "GET", url, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState !== 4) {
        return;
      }

      if (xhr.status >= 200 && xhr.status < 300) {
        try {
          var payload = JSON.parse(xhr.responseText);
          onDone(payload);
        } catch (error) {
          onDone(null);
        }
      } else {
        onDone(null);
      }
    };
    xhr.send();
  }

  function requestText(url, onDone) {
    var xhr = new XMLHttpRequest();
    xhr.open("GET", url, true);
    xhr.onreadystatechange = function() {
      if (xhr.readyState !== 4) {
        return;
      }

      if (xhr.status >= 200 && xhr.status < 300) {
        onDone(xhr.responseText);
      } else {
        onDone(null);
      }
    };
    xhr.send();
  }

  function escapeHtml(rawValue) {
    if (rawValue === null || rawValue === undefined) {
      return "—";
    }

    var textValue = String(rawValue);
    return textValue
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/\"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  function formatList(list, fallbackText) {
    if (!list || !list.length) {
      return fallbackText || "—";
    }
    return list.map(escapeHtml).join(", ");
  }

  function formatDhcp(value) {
    if (value === "observed") {
      return "Observed";
    }
    if (value === "not_observed") {
      return "Not observed";
    }
    return "Unknown";
  }

  function formatFlags(flags) {
    if (!flags || !flags.length) {
      return "—";
    }

    var parts = [];
    var labelMap = {
      l2_only: "L2-only",
      multiple_ips: "Multiple IPs",
      multiple_interfaces: "Multiple interfaces",
      multiple_hostnames: "Multiple hostnames",
      connection_ambiguous: "Connection ambiguous",
      ip_conflict: "IP conflict"
    };
    flags.forEach(function(flag) {
      if (!flag || !flag.type) {
        return;
      }
      var label = labelMap[flag.type] || flag.type;
      if (flag.value) {
        parts.push(escapeHtml(label) + ": " + escapeHtml(flag.value));
      } else {
        parts.push(escapeHtml(label));
      }
    });

    return parts.length ? parts.join(", ") : "—";
  }

  function isIpv6LinkLocal(ipAddress) {
    if (!ipAddress || ipAddress.indexOf(":") === -1) {
      return false;
    }
    return ipAddress.toLowerCase().indexOf("fe80:") === 0;
  }

  function isIpv4LinkLocal(ipAddress) {
    if (!ipAddress || ipAddress.indexOf(":") !== -1) {
      return false;
    }
    return ipAddress.indexOf("169.254.") === 0;
  }

  function filterIpAddresses(ipAddresses) {
    if (!ipAddresses || !ipAddresses.length) {
      return [];
    }

    var hideIpv6 = hideIpv6LinkLocalToggle.checked;
    var hideIpv4 = hideIpv4LinkLocalToggle.checked;
    return ipAddresses.filter(function(ipAddress) {
      if (hideIpv6 && isIpv6LinkLocal(ipAddress)) {
        return false;
      }
      if (hideIpv4 && isIpv4LinkLocal(ipAddress)) {
        return false;
      }
      return true;
    });
  }

  function ipForUrl(ipAddress) {
    if (!ipAddress) {
      return null;
    }
    if (ipAddress.indexOf(":") !== -1 && ipAddress.indexOf("[") === -1) {
      return "[" + ipAddress + "]";
    }
    return ipAddress;
  }

  function sanitizeHost(rawHost) {
    if (!rawHost) {
      return null;
    }
    return rawHost.replace(/[^0-9a-fA-F:\\.\\[\\]%]/g, "");
  }

  function buildActions(ipAddresses, portMap, scanOptions) {
    if (!ipAddresses || !ipAddresses.length) {
      return "—";
    }

    var tcpProbeEnabled = scanOptions && scanOptions.tcp_probe;
    if (!tcpProbeEnabled) {
      return "Not probed";
    }

    var rows = [];
    ipAddresses.forEach(function(ipAddress) {
      var portsForIp = portMap ? portMap[ipAddress] : null;
      if (!portsForIp || !portsForIp.length) {
        return;
      }

      var host = sanitizeHost(ipForUrl(ipAddress));
      if (!host) {
        return;
      }

      var links = [];
      portsForIp.forEach(function(port) {
        if (port === "22") {
          links.push('<a href="ssh://' + host + '">SSH</a>');
        } else if (port === "80") {
          links.push('<a href="http://' + host + '">HTTP</a>');
        } else if (port === "443") {
          links.push('<a href="https://' + host + '">HTTPS</a>');
        } else if (port === "23") {
          links.push('<a href="telnet://' + host + '">Telnet</a>');
        }
      });

      if (links.length) {
        rows.push(escapeHtml(ipAddress) + ": " + links.join(" "));
      }
    });

    if (!rows.length) {
      return "No open ports";
    }

    return rows.join("<br/>");
  }

  function setActiveTab(tabId) {
    tabSections.forEach(function(section) {
      section.style.display = "none";
    });
    tabButtons.forEach(function(button) {
      if (button.getAttribute("data-tab") === tabId) {
        button.classList.add("cbi-button-action");
      } else {
        button.classList.remove("cbi-button-action");
      }
    });

    var activeSection = document.getElementById("network-scan-tab-" + tabId);
    if (activeSection) {
      activeSection.style.display = "block";
    }
  }

  function renderEvidenceBlock(container, titleText, contentText) {
    var block = document.createElement("div");
    block.style.marginBottom = "12px";

    var title = document.createElement("div");
    title.style.fontWeight = "bold";
    title.textContent = titleText;
    block.appendChild(title);

    var pre = document.createElement("pre");
    pre.textContent = contentText || "Not available.";
    block.appendChild(pre);

    container.appendChild(block);
  }

  var evidenceSources = {
    scope: [
      { label: "Scan targets", source: "scan_targets" }
    ],
    arp: [
      { label: "arp-scan", source: "arp_scan" },
      { label: "ip neigh (text)", source: "ip_neigh" },
      { label: "ip neigh (json)", source: "ip_neigh_json" }
    ],
    dhcp: [
      { label: "dhcp.leases", source: "dhcp_leases" }
    ],
    wifi: [
      { label: "iw dev", source: "iw_dev" },
      { label: "iw station dump", source: "iw_stations" }
    ],
    "nmap-ping": [
      { label: "nmap -sn output", source: "nmap_ping" }
    ],
    "nmap-ports": [
      { label: "nmap open ports", source: "nmap_ports" }
    ],
    "host-hints": [
      { label: "luci host hints", source: "host_hints" }
    ],
    interfaces: [
      { label: "network.interface dump", source: "network_interface_dump" }
    ]
  };

  function loadEvidenceTab(tabId) {
    var container = document.getElementById("network-scan-tab-" + tabId);
    var sources = evidenceSources[tabId];
    if (!container || !sources) {
      return;
    }

    while (container.firstChild) {
      container.removeChild(container.firstChild);
    }

    sources.forEach(function(source) {
      var placeholder = document.createElement("div");
      placeholder.textContent = "Loading " + source.label + "…";
      container.appendChild(placeholder);

      requestText(rawUrlBase + "?source=" + encodeURIComponent(source.source), function(text) {
        if (container.contains(placeholder)) {
          container.removeChild(placeholder);
        }
        renderEvidenceBlock(container, source.label, text);
      });
    });
  }

  function renderTable(results) {
    if (!results || !results.devices || !results.devices.length) {
      tableBody.innerHTML = '<tr class="tr"><td class="td" colspan="13">No devices observed.</td></tr>';
      return;
    }

    var scanOptions = results.meta ? results.meta.scan_options : null;
    var rows = [];
    results.devices.forEach(function(device) {
      var ipAddresses = filterIpAddresses(device.ip_addresses || []);
      var connections = device.connection || [];
      var interfaces = device.interfaces || [];
      var seenVia = device.seen_via || [];
      var portMap = device.ports || {};

      var rssiDisplay = device.rssi !== null && device.rssi !== undefined
        ? device.rssi + " dBm"
        : "—";

      rows.push(
        '<tr class="tr">' +
          '<td class="td">' + escapeHtml(device.mac || "—") + '</td>' +
          '<td class="td">' + escapeHtml(device.vendor || "—") + '</td>' +
          '<td class="td">' + formatList(ipAddresses) + '</td>' +
          '<td class="td">' + escapeHtml(formatDhcp(device.dhcp)) + '</td>' +
          '<td class="td">' + formatList(device.hostnames) + '</td>' +
          '<td class="td">' + formatList(connections) + '</td>' +
          '<td class="td">' + formatList(interfaces) + '</td>' +
          '<td class="td">' + escapeHtml(rssiDisplay) + '</td>' +
          '<td class="td">' + formatList(seenVia) + '</td>' +
          '<td class="td">' + escapeHtml(device.liveness || "unknown") + '</td>' +
          '<td class="td">' + escapeHtml(device.last_seen || "—") + '</td>' +
          '<td class="td">' + formatFlags(device.flags) + '</td>' +
          '<td class="td">' + buildActions(ipAddresses, portMap, scanOptions) + '</td>' +
        '</tr>'
      );
    });

    tableBody.innerHTML = rows.join("");
  }

  function renderMeta(meta) {
    if (!meta) {
      metaNode.textContent = "";
      return;
    }

    var parts = [];
    if (meta.scan_started) {
      parts.push("Scan started: " + meta.scan_started);
    }
    if (meta.scan_finished) {
      parts.push("Scan finished: " + meta.scan_finished);
    }
    if (meta.scan_duration_seconds !== undefined && meta.scan_duration_seconds !== null) {
      parts.push("Duration: " + meta.scan_duration_seconds + "s");
    }
    if (meta.scan_options) {
      var arpText = meta.scan_options.arp_scan ? "on" : "off";
      var icmpText = meta.scan_options.icmp_sweep ? "on" : "off";
      var tcpText = meta.scan_options.tcp_probe ? "on" : "off";
      var scopeText = meta.scan_options.scope_mode || "auto";
      parts.push("ARP scan: " + arpText);
      parts.push("ICMP sweep: " + icmpText);
      if (meta.scan_options.tcp_probe) {
        parts.push("TCP ports: " + meta.scan_options.tcp_ports);
      } else {
        parts.push("TCP probe: " + tcpText);
      }
      parts.push("Scope: " + scopeText);
      if (scopeText === "custom" && meta.scan_options.scope_targets) {
        parts.push("Targets: " + meta.scan_options.scope_targets);
      }
    }

    metaNode.textContent = parts.join(" · ");
  }

  function updateStatus() {
    requestJson(statusUrl, "GET", function(status) {
      if (!status) {
        statusNode.textContent = "Status unavailable";
        return;
      }

      var statusText = status.status || "idle";
      statusNode.textContent = "Status: " + statusText;

      if (statusText === "running" || statusText === "busy") {
        if (!pollingTimer) {
          pollingTimer = setInterval(function() {
            updateStatus();
            loadResults();
          }, 2000);
        }
      } else if (pollingTimer) {
        clearInterval(pollingTimer);
        pollingTimer = null;
      }
    });
  }

  function loadResults() {
    requestJson(resultsUrl, "GET", function(results) {
      if (!results) {
        renderTable({ devices: [] });
        return;
      }
      lastResults = results;
      lastEvidenceTab = null;
      renderTable(results);
      renderMeta(results.meta || {});
    });
  }

  function updateScopeEnabled() {
    scopeTargetsInput.disabled = scopeSelect.value !== "custom";
  }

  function updateTcpPortsEnabled() {
    tcpPortsInput.disabled = !tcpProbeToggle.checked;
  }

  scanButton.addEventListener("click", function() {
    statusNode.textContent = "Status: starting";
    var params = [];
    if (arpScanToggle.checked) {
      params.push("arp_scan=1");
    }
    if (icmpSweepToggle.checked) {
      params.push("icmp_sweep=1");
    }
    if (tcpProbeToggle.checked) {
      params.push("tcp_probe=1");
      params.push("tcp_ports=" + encodeURIComponent(tcpPortsInput.value));
    }
    params.push("scope=" + encodeURIComponent(scopeSelect.value));
    if (scopeSelect.value === "custom") {
      params.push("scope_targets=" + encodeURIComponent(scopeTargetsInput.value));
    }
    var requestUrl = scanUrl + (params.length ? "?" + params.join("&") : "");
    requestJson(requestUrl, "POST", function() {
      updateStatus();
      loadResults();
    });
  });

  tcpProbeToggle.addEventListener("change", updateTcpPortsEnabled);
  scopeSelect.addEventListener("change", updateScopeEnabled);
  hideIpv6LinkLocalToggle.addEventListener("change", function() {
    if (lastResults) {
      renderTable(lastResults);
    }
  });
  hideIpv4LinkLocalToggle.addEventListener("change", function() {
    if (lastResults) {
      renderTable(lastResults);
    }
  });

  tabButtons.forEach(function(button) {
    button.addEventListener("click", function() {
      var tabId = button.getAttribute("data-tab");
      if (!tabId) {
        return;
      }
      setActiveTab(tabId);
      if (evidenceSources[tabId] && lastEvidenceTab !== tabId) {
        loadEvidenceTab(tabId);
        lastEvidenceTab = tabId;
      }
    });
  });

  updateTcpPortsEnabled();
  updateScopeEnabled();
  setActiveTab("summary");
  updateStatus();
  loadResults();
})();
</script>

<%+footer%>
